<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1">




<title>android https 抓包 | BUF1024!!!</title>
<link rel="canonical" href="https://luoguochun.cn/post/2023-03-21-android-https/">
<meta name="description" content="前几天有个需求，要破解一下某个app的部分通讯协议，需要了解一下某部分功能如何实现，甚至通过其协议抓取一些数据。而这个app只有androi" />
<meta property="og:type" content="article" />
<meta property="og:title" content="android https 抓包 | BUF1024!!!" />
<meta property="og:url" content="https://luoguochun.cn/post/2023-03-21-android-https/" />
<meta property="og:description" content="前几天有个需求，要破解一下某个app的部分通讯协议，需要了解一下某部分功能如何实现，甚至通过其协议抓取一些数据。而这个app只有androi" />








<link rel="stylesheet" href="/lib/icofont/icofont.min.css" />
<link rel="stylesheet" href="/css/syntax.css" />
<link rel="stylesheet" href="/css/style.css" />
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

</head>

<body>
    <header class="header-wrapper">
    <div class="header">
        <a class="site-title" href="https://luoguochun.cn">BUF1024!!!</a>

        <nav class="menu">
            
                <div class="menu-item">
                    
                        <a href="/">主页</a>
                    
                </div>
            
                <div class="menu-item">
                    
                        <a href="/post/">文章</a>
                    
                </div>
            
                <div class="menu-item">
                    
                        <a href="/tags/">标签</a>
                    
                </div>
            
                <div class="menu-item">
                    
                        <a href="/categories/">分类</a>
                    
                </div>
            
                <div class="menu-item">
                    
                        <a href="/about/">关于</a>
                    
                </div>
            
        </nav>
    </div>
</header>

    <main class="main-wrapper">

        <div class="main">
            <div style="display: flex; flex-direction: column;"></div>
                

<section class="single">
    <h1 class="title">android https 抓包</h1>

    <div class="tip">
        <time datetime="2023-03-21 08:10:12 &#43;0800 CST">2023/03/21</time>
        <span class="split">·</span>
        <span> 2068 words </span>
        <span class="split">·</span>
        <span>
            5 minutes to read
        </span>
    </div>

    <div class="taxonomies">
        
        <div>
            Categories:
            
                <a href="/categories/flutter">flutter</a>
            
                <a href="/categories/%E9%87%8F%E5%8C%96">量化</a>
            
        </div>
        

        
            <div>
                Tags:
                
                    <a href="/tags/android">android</a>
                
                    <a href="/tags/%E9%87%8F%E5%8C%96">量化</a>
                
            </div>
        
    </div>

    <hr />

    <div class="content">
        <p>前几天有个需求，要破解一下某个app的部分通讯协议，需要了解一下某部分功能如何实现，甚至通过其协议抓取一些数据。而这个app只有android版本和ios版本。从初步看，这个app是同React Native写的。</p>
<p>虽然https是加密的，不过查看https本来感觉这并不是什么太复杂的事情，引入一个中间人就可以了。虽然在浏览器会弹出CA不可信任的警告，不过对于app来说，如果不作特殊处理（一般人也不会特殊处理），一般没什么影响。而这事在很久之前也是做过的了。没想到现在的android却提高了难度。记录一下步骤，以备后续可能需要查看。</p>
<h3 id="普通-https-抓包">普通 https 抓包 <a href="#%e6%99%ae%e9%80%9a-https-%e6%8a%93%e5%8c%85" class="anchor">🔗</a></h3><p>在mac下面最常用的是charles，其他平台有类似的软件。 步骤如下：</p>
<ul>
<li>
<p>charles打开代理</p>
<p>如图示，如此经过操作后，经过此代理的http/https报文即可被捕获（中间人）。</p>
<p>代理设置:</p>
<p><img src="/img/charles/step0-1.png" alt="代理设置"></p>
<p>SSL设置:</p>
<p><img src="/img/charles/step0-0.png" alt="SSL设置"></p>
<p>打开代理:</p>
<p><img src="/img/charles/step0-2.png" alt="打开代理"></p>
</li>
<li>
<p>配置服务端客户端证书</p>
<p>经过上述配置，虽然可以实现了中间人捕获报文，可是https的内容是无法查看的，所以需要配置证书后才可以解密。步骤如图示：</p>
<ul>
<li>
<p>电脑端：</p>
<pre><code>添加证书：

![添加信任证书](/img/charles/step1-1.png)

设置信任证书：

![设置信任](/img/charles/step1-2.png)
</code></pre>
</li>
<li>
<p>手机端：</p>
<pre><code>设置代理：

![设置代理](/img/charles/step2-1.png)

添加信任的证书：

![添加信任的证书](/img/charles/step2-2.png)
</code></pre>
</li>
</ul>
</li>
</ul>
<p>以上便是网上能搜索到的方式，也是以前自己抓取https报文的步骤，如果一切那么顺利便不会有这篇记录。因为在从android7.0开始后，android手机即使你添加信任的证书后，系统依然是不信任你的证书的，只信任系统的证书。所以，任何请求都不会使用到这个用户证书，也因此，https的报文依然是无法解密的。</p>
<h3 id="android7以上https抓包">android7以上https抓包 <a href="#android7%e4%bb%a5%e4%b8%8ahttps%e6%8a%93%e5%8c%85" class="anchor">🔗</a></h3><p>针对android7.0以上系统，这个办法的解决方式也是挺粗暴的，既然只信任系统证书，那么就移动真是到系统目录不就可以了？而此方式必须要系统root方可以。这是不愿意做的，除非可以使用一个已经root的模拟器，不过这个好像比较难找。</p>
<p>除此之外，网上还有一种方式，那就是自己编码让其信任用户证书。具体的步骤也挺简单的，如下：</p>
<ul>
<li>
<p>新建network_security_conf.xml文件</p>
<p>放在res/xml下面，此文件意思就告诉系统，让系统信任用户证书，内容大体如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p>AndroidManifest.xml修改</p>
<p>与此同时在AndroidManifest.xml文件的application字段后增加<code>android:usesCleartextTraffic=&quot;true&quot; android:networkSecurityConfig=&quot;@xml/network_security_config&quot;</code>内容。</p>
</li>
</ul>
<p>然而，这个app并非自己所写的，本来就没有源码，所以必须反编译后修改，再重新签名。这个方式网上也有比较详细的方式，大体涉及三个工具：</p>
<ol>
<li>
<p>apktool，编译和反编译apk，从apk中提取图片和布局资源</p>
</li>
<li>
<p>dex2jar，将可运行文件classes.dex反编译为jar源码文件</p>
</li>
<li>
<p>jd-gui，查看jar源码文件</p>
</li>
</ol>
<p>网上已经有比较详细的方式，这里不再累赘。而现实修改的只涉及资源文件，所以，只用到apktool即可，而且只需要两个命令。</p>
<p>解包：<code>apktool d -o dec xx.apk</code>  重新打包：<code>apktool b -o yy.apk dec/</code></p>
<p>重新打包后的apk需要经过重新签名之后，方可安装，步骤：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">#1 使用keytool生成密钥，如</span>
</span></span><span class="line"><span class="cl">keytool -genkeypair -v -keystore hello.keystore -alias hello -keyalg RSA <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>          -keysize <span class="m">2048</span> -validity <span class="m">10000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#2 重新打包</span>
</span></span><span class="line"><span class="cl">apktool b -o yy.apk dec/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#3 重新签名，使用android sdk tool自带的工具</span>
</span></span><span class="line"><span class="cl"><span class="nv">$ANDROID_HOME</span>/build-tools/30.0.3/apksigner sign --ks hello.keystore --ks-key-alias hello yy.apk
</span></span></code></pre></td></tr></table>
</div>
</div><p>apktool重新打包时，有一个坑。在AndroidManifest.xml文件里，如果<code>android:extractNativeLibs=&quot;false&quot;</code>，则需要修改为<code>android:extractNativeLibs=&quot;true&quot;</code>，否则按装时会报错。</p>
<p>按照上述修改后，本以为就可以了，可事实上，压根就没有解决https无法查看的问题。这就如同说TCP挥手必须要四次才行的那些背八股文的人一样，根本就没有经过实践，把不完整的知识当是真理。当然，因为这是修改别的软件，不知道自己编写的软件这么修改后，有没有效果。</p>
<p>经过一番瞎折腾和摸索，才找到网上基本没有说过的修改方式（重点）：</p>
<p>既然你是android 7.0以下才可以用，那么我就把你运行目标修改为这个目标，是不是可以？修改点：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="c1">#1 AndroidManifest.xml 修改为</span>
</span></span><span class="line"><span class="cl"><span class="n">platformBuildVersionCode</span><span class="o">=</span><span class="s2">&#34;23&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#2 apktool.yml修改为</span>
</span></span><span class="line"><span class="cl"><span class="n">sdkInfo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">minSdkVersion</span><span class="p">:</span> <span class="s1">&#39;23&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="n">targetSdkVersion</span><span class="p">:</span> <span class="s1">&#39;23&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后，然后，结果居然行了！！！</p>
<p><img src="/img/charles/https_crack.png" alt="https-crack"></p>
<h3 id="小小结">小小结 <a href="#%e5%b0%8f%e5%b0%8f%e7%bb%93" class="anchor">🔗</a></h3><ol>
<li>原来apk反编译重新打包如此简单（修改源码例外，特别是混淆之后的）</li>
<li>android 7后http是抓包变得繁杂</li>
<li>网上的答案很多的复制黏贴，不一定正确，自己实践过的才是可靠的，然而并不是所有人实践过，万一他们一直认为他们没实践过的是真理……</li>
</ol>

    </div>

    
</section>


                <hr>
                

<div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2023-03-21 08:10:12 \u002b0800 CST',
        title: 'android https 抓包',
        clientID: '72786bf87c19beec6abe',
        clientSecret: '93ce647699b49ea6434332d36b0122a4ad8281ad',
        repo: 'buf1024.github.io',
        owner: 'buf1024',
        admin: ['buf1024'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

            </div>
        </div>

        <div class="side">
            
            <div class="side-recent">
    <h2 class="side-title">
        <a href="/post/">Recent Post</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/post/2024-01-08-%E5%89%8D%E7%AB%AF%E4%BF%9D%E5%A7%86%E7%BA%A7%E9%85%8D%E7%BD%AE/">前端保姆级配置</a>
            </li>
        
            <li>
                <a href="/post/2023-12-26-rust-proc-macro/">rust 过程宏</a>
            </li>
        
            <li>
                <a href="/post/2023-09-21-rust-panic/">一行代码让 rustc panic</a>
            </li>
        
            <li>
                <a href="/post/2023-07-19-flutter-muti-window/">Flutter 桌面端多窗口支持</a>
            </li>
        
            <li>
                <a href="/post/2023-07-04-hiqradio/">hiqradio 一个简单的收音机软件</a>
            </li>
        
    </ul>
</div>

            
            <div class="side-recent">
    <h2 class="side-title">
        <a href="/talib-doc/">Recent Talib doc</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/talib-doc/func_groups/math_operators/">16 数学运算符(Math Operator Functions )</a>
            </li>
        
            <li>
                <a href="/talib-doc/func_groups/math_transform/">15 数学变换(Math Transform Functions)</a>
            </li>
        
            <li>
                <a href="/talib-doc/func_groups/statistic_functions/">14 统计功能(Statistic Functions)</a>
            </li>
        
            <li>
                <a href="/talib-doc/func_groups/pattern_recognition/">13 形态识别(Pattern Recognition Functions)</a>
            </li>
        
            <li>
                <a href="/talib-doc/func_groups/cycle_indicators/">12 周期指标(Cycle Indicator Functions)</a>
            </li>
        
    </ul>
</div>

            
            <div class="side-categories">
    <h2>Categories</h2>
    <hr />

    <ul>
        
            <li>
                <a href="/categories/android">android(1)</a>
            </li>
        
            <li>
                <a href="/categories/app">app(1)</a>
            </li>
        
            <li>
                <a href="/categories/asm">asm(2)</a>
            </li>
        
            <li>
                <a href="/categories/c">c(6)</a>
            </li>
        
            <li>
                <a href="/categories/django">django(1)</a>
            </li>
        
            <li>
                <a href="/categories/flutter">flutter(7)</a>
            </li>
        
            <li>
                <a href="/categories/frontend">frontend(1)</a>
            </li>
        
            <li>
                <a href="/categories/gcc">gcc(2)</a>
            </li>
        
            <li>
                <a href="/categories/gdb">gdb(1)</a>
            </li>
        
            <li>
                <a href="/categories/git">git(2)</a>
            </li>
        
            <li>
                <a href="/categories/go">go(1)</a>
            </li>
        
            <li>
                <a href="/categories/http">http(1)</a>
            </li>
        
            <li>
                <a href="/categories/https">https(1)</a>
            </li>
        
            <li>
                <a href="/categories/linux">linux(7)</a>
            </li>
        
            <li>
                <a href="/categories/mac">mac(1)</a>
            </li>
        
            <li>
                <a href="/categories/misc">misc(9)</a>
            </li>
        
            <li>
                <a href="/categories/multi_window">multi_window(1)</a>
            </li>
        
            <li>
                <a href="/categories/orm">orm(1)</a>
            </li>
        
            <li>
                <a href="/categories/os">os(2)</a>
            </li>
        
            <li>
                <a href="/categories/python">python(4)</a>
            </li>
        
            <li>
                <a href="/categories/reactjs">reactjs(3)</a>
            </li>
        
            <li>
                <a href="/categories/rust">rust(6)</a>
            </li>
        
            <li>
                <a href="/categories/ssh">ssh(1)</a>
            </li>
        
            <li>
                <a href="/categories/tcp">tcp(6)</a>
            </li>
        
            <li>
                <a href="/categories/tdd">tdd(1)</a>
            </li>
        
            <li>
                <a href="/categories/unittest">unittest(2)</a>
            </li>
        
            <li>
                <a href="/categories/vcs">vcs(1)</a>
            </li>
        
            <li>
                <a href="/categories/vim">vim(3)</a>
            </li>
        
            <li>
                <a href="/categories/web">web(2)</a>
            </li>
        
            <li>
                <a href="/categories/webui">webui(1)</a>
            </li>
        
            <li>
                <a href="/categories/windows">windows(1)</a>
            </li>
        
            <li>
                <a href="/categories/%E6%94%B6%E9%9F%B3%E6%9C%BA">收音机(1)</a>
            </li>
        
            <li>
                <a href="/categories/%E6%9E%84%E6%9E%B6">构架(3)</a>
            </li>
        
            <li>
                <a href="/categories/%E9%87%8F%E5%8C%96">量化(2)</a>
            </li>
        
    </ul>
</div>

            <div class="side-tags">
    <h2>Tags</h2>
    <hr />

    <ul>
        
            <li>
                <a href="/tags/android">android (3)</a>
            </li>
        
            <li>
                <a href="/tags/asm">asm (2)</a>
            </li>
        
            <li>
                <a href="/tags/bt">bt (1)</a>
            </li>
        
            <li>
                <a href="/tags/c">c (20)</a>
            </li>
        
            <li>
                <a href="/tags/c&#43;&#43;">c&#43;&#43; (1)</a>
            </li>
        
            <li>
                <a href="/tags/coroutine">coroutine (1)</a>
            </li>
        
            <li>
                <a href="/tags/css">css (2)</a>
            </li>
        
            <li>
                <a href="/tags/django">django (1)</a>
            </li>
        
            <li>
                <a href="/tags/flutter">flutter (6)</a>
            </li>
        
            <li>
                <a href="/tags/frontend">frontend (1)</a>
            </li>
        
            <li>
                <a href="/tags/gas">gas (2)</a>
            </li>
        
            <li>
                <a href="/tags/gcc">gcc (2)</a>
            </li>
        
            <li>
                <a href="/tags/gdb">gdb (1)</a>
            </li>
        
            <li>
                <a href="/tags/git">git (3)</a>
            </li>
        
            <li>
                <a href="/tags/go">go (1)</a>
            </li>
        
            <li>
                <a href="/tags/gtest">gtest (3)</a>
            </li>
        
            <li>
                <a href="/tags/html">html (1)</a>
            </li>
        
            <li>
                <a href="/tags/http">http (2)</a>
            </li>
        
            <li>
                <a href="/tags/https">https (1)</a>
            </li>
        
            <li>
                <a href="/tags/javascript">javascript (1)</a>
            </li>
        
            <li>
                <a href="/tags/jquery">jquery (1)</a>
            </li>
        
            <li>
                <a href="/tags/js">js (2)</a>
            </li>
        
            <li>
                <a href="/tags/libevent">libevent (1)</a>
            </li>
        
            <li>
                <a href="/tags/linux">linux (10)</a>
            </li>
        
            <li>
                <a href="/tags/mac">mac (1)</a>
            </li>
        
            <li>
                <a href="/tags/makefile">makefile (1)</a>
            </li>
        
            <li>
                <a href="/tags/minix3">minix3 (2)</a>
            </li>
        
            <li>
                <a href="/tags/misc">misc (1)</a>
            </li>
        
            <li>
                <a href="/tags/orm">orm (1)</a>
            </li>
        
            <li>
                <a href="/tags/os">os (2)</a>
            </li>
        
            <li>
                <a href="/tags/proc">proc (1)</a>
            </li>
        
            <li>
                <a href="/tags/python">python (7)</a>
            </li>
        
            <li>
                <a href="/tags/react-native">react-native (2)</a>
            </li>
        
            <li>
                <a href="/tags/redis">redis (2)</a>
            </li>
        
            <li>
                <a href="/tags/rpm">rpm (1)</a>
            </li>
        
            <li>
                <a href="/tags/rsa">rsa (1)</a>
            </li>
        
            <li>
                <a href="/tags/rust">rust (3)</a>
            </li>
        
            <li>
                <a href="/tags/rust-lib">rust-lib (3)</a>
            </li>
        
            <li>
                <a href="/tags/server">server (1)</a>
            </li>
        
            <li>
                <a href="/tags/sqlalchemy">sqlalchemy (1)</a>
            </li>
        
            <li>
                <a href="/tags/ssh">ssh (1)</a>
            </li>
        
            <li>
                <a href="/tags/ssl/tls">ssl/tls (1)</a>
            </li>
        
            <li>
                <a href="/tags/tcp">tcp (7)</a>
            </li>
        
            <li>
                <a href="/tags/tcp-optition">tcp-optition (1)</a>
            </li>
        
            <li>
                <a href="/tags/tcpdump">tcpdump (1)</a>
            </li>
        
            <li>
                <a href="/tags/tdd">tdd (2)</a>
            </li>
        
            <li>
                <a href="/tags/tidbit">tidbit (1)</a>
            </li>
        
            <li>
                <a href="/tags/vc">vc (1)</a>
            </li>
        
            <li>
                <a href="/tags/vcs">vcs (3)</a>
            </li>
        
            <li>
                <a href="/tags/vim">vim (3)</a>
            </li>
        
            <li>
                <a href="/tags/vite">vite (1)</a>
            </li>
        
            <li>
                <a href="/tags/webui">webui (1)</a>
            </li>
        
            <li>
                <a href="/tags/win32">win32 (1)</a>
            </li>
        
            <li>
                <a href="/tags/wireshark">wireshark (1)</a>
            </li>
        
            <li>
                <a href="/tags/%E6%9E%84%E6%9E%B6">构架 (2)</a>
            </li>
        
            <li>
                <a href="/tags/%E9%87%8F%E5%8C%96">量化 (2)</a>
            </li>
        
            <li>
                <a href="/tags/%E6%94%B6%E9%9F%B3%E6%9C%BA">收音机 (1)</a>
            </li>
        
            <li>
                <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1">微服务 (1)</a>
            </li>
        
            <li>
                <a href="/tags/%E5%BE%AE%E4%BF%A1">微信 (1)</a>
            </li>
        
    </ul>
</div>

        </div>
    </main>
    <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        id: '2023-03-21 08:10:12 \u002b0800 CST',
        title: 'android https 抓包',
        clientID: '72786bf87c19beec6abe',
        clientSecret: '93ce647699b49ea6434332d36b0122a4ad8281ad',
        repo: 'buf1024.github.io',
        owner: 'buf1024',
        admin: ['buf1024'],
        body: decodeURI(location.href)
    });
    gitalk.render('gitalk-container');
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by
        gitalk.</a></noscript>

    

    
</body>

</html>